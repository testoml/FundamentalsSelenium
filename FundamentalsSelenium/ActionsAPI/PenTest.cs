using OpenQA.Selenium.Interactions;
using OpenQA.Selenium;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using FundamentalsSelenium;

namespace FundamentalsSeleniumNUnit.ActionsAPI
{
    [TestClass]
    public class PenTest:BaseTest
    {
     
        [TestMethod]
        //Using a Pen
        public void UsePen()
        {

            driver.Url = "https://selenium.dev/selenium/web/pointerActionsPage.html";
            IWebElement pointerArea = driver.FindElement(By.Id("pointerArea"));
            ActionBuilder actionBuilder = new();//allow create an action
            PointerInputDevice pen = new(PointerKind.Pen, "default pen"); //represent mouse, finger

            actionBuilder.AddAction(pen.CreatePointerMove(pointerArea, 0, 0, TimeSpan.FromMilliseconds(800)));
            actionBuilder.AddAction(pen.CreatePointerDown(MouseButton.Left));
            actionBuilder.AddAction(pen.CreatePointerMove(CoordinateOrigin.Pointer,
                2, 2, TimeSpan.Zero));
            actionBuilder.AddAction(pen.CreatePointerUp(MouseButton.Left));
            ((IActionExecutor)driver).PerformActions(actionBuilder.ToActionSequenceList());

            var moves = driver.FindElements(By.ClassName("pointermove"));
            var moveTo = GetProperties(moves.ElementAt(0));
            var down = GetProperties(driver.FindElement(By.ClassName("pointerdown")));
            var moveBy = GetProperties(moves.ElementAt(1));
            var up = GetProperties(driver.FindElement(By.ClassName("pointerup")));

            Point location = pointerArea.Location;
            Size size = pointerArea.Size;
            decimal centerX = location.X + size.Width / 2;
            decimal centerY = location.Y + size.Height / 2;

            Assert.AreEqual(moveTo["button"], "-1");
            Assert.AreEqual(moveTo["pointerType"], "pen");
            Assert.IsTrue(VerifyEquivalent(centerX, moveTo["pageX"]));
            Assert.IsTrue(VerifyEquivalent(centerY, moveTo["pageY"]));
            Assert.AreEqual(down["button"], "0");
            Assert.AreEqual(down["pointerType"], "pen");
            Assert.IsTrue(VerifyEquivalent(centerX, down["pageX"]));
            Assert.IsTrue(VerifyEquivalent(centerY, down["pageY"]));
            Assert.AreEqual(moveBy["button"], "-1");
            Assert.AreEqual(moveBy["pointerType"], "pen");
            Assert.IsTrue(VerifyEquivalent(centerX + 2, moveBy["pageX"]));
            Assert.IsTrue(VerifyEquivalent(centerY + 2, moveBy["pageY"]));
            Assert.AreEqual(up["button"], "0");
            Assert.AreEqual(up["pointerType"], "pen");
            Assert.IsTrue(VerifyEquivalent(centerX + 2, up["pageX"]));
            Assert.IsTrue(VerifyEquivalent(centerY + 2, up["pageY"]));
            driver.Quit();
        }

        [TestMethod]
        //Adding Pointer Event Attributes
        public void SetPointerEventProperties()
        {
            driver.Url = "https://selenium.dev/selenium/web/pointerActionsPage.html";

            IWebElement pointerArea = driver.FindElement(By.Id("pointerArea"));
            ActionBuilder actionBuilder = new();
            PointerInputDevice pen = new(PointerKind.Pen, "default pen");
            PointerInputDevice.PointerEventProperties properties = new()
            {
                TiltX = -72,
                TiltY = 9,
                Twist = 86,
            };
            actionBuilder.AddAction(pen.CreatePointerMove(pointerArea, 0, 0, TimeSpan.FromMilliseconds(800)));
            actionBuilder.AddAction(pen.CreatePointerDown(MouseButton.Left));
            actionBuilder.AddAction(pen.CreatePointerMove(CoordinateOrigin.Pointer,
                2, 2, TimeSpan.Zero, properties));
            actionBuilder.AddAction(pen.CreatePointerUp(MouseButton.Left));
            ((IActionExecutor)driver).PerformActions(actionBuilder.ToActionSequenceList());

            var moves = driver.FindElements(By.ClassName("pointermove"));
            var moveTo = GetProperties(moves.ElementAt(0));
            var down = GetProperties(driver.FindElement(By.ClassName("pointerdown")));
            var moveBy = GetProperties(moves.ElementAt(1));
            var up = GetProperties(driver.FindElement(By.ClassName("pointerup")));

            Point location = pointerArea.Location;
            Size size = pointerArea.Size;
            decimal centerX = location.X + size.Width / 2;
            decimal centerY = location.Y + size.Height / 2;

            Assert.AreEqual(moveTo["button"], "-1");
            Assert.AreEqual(moveTo["pointerType"], "pen");
            Assert.IsTrue(VerifyEquivalent(centerX, moveTo["pageX"]));
            Assert.IsTrue(VerifyEquivalent(centerY, moveTo["pageY"]));
            Assert.AreEqual(down["button"], "0");
            Assert.AreEqual (down["pointerType"], "pen");
            Assert.IsTrue(VerifyEquivalent(centerX, down["pageX"]));
            Assert.IsTrue(VerifyEquivalent(centerY, down["pageY"]));
            Assert.AreEqual(moveBy["button"], "-1");
            Assert.AreEqual (moveBy["pointerType"], "pen");
            Assert.IsTrue(VerifyEquivalent(centerX + 2, moveBy["pageX"]));
            Assert.IsTrue(VerifyEquivalent(centerY + 2, moveBy["pageY"]));
            Assert.AreEqual(moveBy["tiltX"], (-72).ToString());
            Assert.AreEqual(moveBy["tiltY"], (9).ToString());
            Assert.AreEqual(moveBy["twist"], (86).ToString());
            Assert.AreEqual(up["button"], "0");
            Assert.AreEqual(up["pointerType"], "pen");
            Assert.IsTrue(VerifyEquivalent(centerX + 2, up["pageX"]));
            Assert.IsTrue(VerifyEquivalent(centerY + 2, up["pageY"]));
            driver.Quit();
        }

        private static Dictionary<string, string> GetProperties(IWebElement element)
        {
            var str = element.Text;
            str = str[(str.Split()[0].Length + 1)..];
            IEnumerable<string[]> keyValue = str.Split(", ").Select(part => part.Split(":"));
            return keyValue.ToDictionary(split => split[0].Trim(), split => split[1].Trim());
        }

        private static bool VerifyEquivalent(decimal expected, string actual)
        {
            var absolute = Math.Abs(expected - decimal.Parse(actual));
            if (absolute <= 1)
            {
                return true;
            }

            throw new Exception("Expected: " + expected + "; but received: " + actual);
        }
    }
}
